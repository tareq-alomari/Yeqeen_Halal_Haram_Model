!pip install gradio
import gradio as gr
import joblib
import re

# --- الخطوة 0: استرجاع قاعدة المعرفة (القاموس الخبير) ---
# يجب أن يكون هذا القاموس متاحاً لديك من المرحلة الأولى للمشروع
# هذا مجرد مثال مصغر، استخدم القاموس الكامل الخاص بك
comprehensive_ingredients_db = {

#--------------------------------------------------------------------------
#القسم الأول: مكونات محرمة بشكل قاطع (Haram)
#--------------------------------------------------------------------------

#--- مشتقات الخنزير (Pork Derivatives) ---
'pork': {'status': 'حرام', 'reason': 'لحم الخنزير محرم بالنص الصريح في القرآن الكريم.'},
'bacon': {'status': 'حرام', 'reason': 'نوع من لحم الخنزير المقدد والمعالج.'},
'ham': {'status': 'حرام', 'reason': 'لحم فخذ الخنزير، وهو محرم.'},
'lard': {'status': 'حرام', 'reason': 'دهن الخنزير، وهو محرم.'},
'swine': {'status': 'حرام', 'reason': 'اسم آخر للخنزير، وهو محرم.'},
'hog': {'status': 'حرام', 'reason': 'اسم آخر للخنزير، وهو محرم.'},
'boar': {'status': 'حرام', 'reason': 'الخنزير البري، وهو محرم.'},
'porcine': {'status': 'حرام', 'reason': 'كلمة لاتينية تعني أن المصدر من الخنزير.'},
'speck': {'status': 'حرام', 'reason': 'نوع من اللحم المقدد من الخنزير.'},
'schwein': {'status': 'حرام', 'reason': "كلمة ألمانية تعني 'خنزير'."},
'prosciutto': {'status': 'حرام', 'reason': 'نوع من لحم الخنزير الإيطالي المجفف.'},

# --- الكحول والمسكرات (Alcohol and Intoxicants) ---
'alcohol': {'status': 'حرام', 'reason': 'كل مسكر خمر، وكل خمر حرام.'},
'ethanol': {'status': 'حرام', 'reason': 'الاسم الكيميائي للكحول المسكر.'},
'ethyl alcohol': {'status': 'حرام', 'reason': 'الاسم الكيميائي للكحول المسكر.'},
'wine': {'status': 'حرام', 'reason': 'الخمر، وهو محرم بالنص الصريح.'},
'beer': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المسكرة.'},
'liquor': {'status': 'حرام', 'reason': 'مصطلح عام للمشروبات الكحولية المقطرة.'},
'liqueur': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المحلاة.'},
'brandy': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المسكرة.'},
'cognac': {'status': 'حرام', 'reason': 'نوع من البراندي، وهو مسكر.'},
'gin': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المسكرة.'},
'rum': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المسكرة.'},
'vodka': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المسكرة.'},
'whisky': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المسكرة.'},
'whiskey': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المسكرة.'},
'champagne': {'status': 'حرام', 'reason': 'نوع من النبيذ الفوار المسكر.'},
'sake': {'status': 'حرام', 'reason': 'نبيذ الأرز الياباني، وهو مسكر.'},
'vermouth': {'status': 'حرام', 'reason': 'نبيذ مقوى ومنكّه، وهو مسكر.'},
'sherry': {'status': 'حرام', 'reason': 'نوع من النبيذ المقوى، وهو مسكر.'},
'port': {'status': 'حرام', 'reason': 'نوع من النبيذ المقوى، وهو مسكر.'},
'absinthe': {'status': 'حرام', 'reason': 'نوع من المشروبات الكحولية المسكرة.'},

# --- حيوانات ومواد محرمة أخرى ---
'blood': {'status': 'حرام', 'reason': 'الدم المسفوح محرم بالنص الصريح.'},
'carrion': {'status': 'حرام', 'reason': 'الميتة (الحيوان الذي لم يذكَّ بالطريقة الشرعية).'},
'carmine': {'status': 'حرام', 'reason': 'صبغة (E120) تُستخرج من الحشرات، وهي محرمة عند جمهور العلماء.'},
'cochineal': {'status': 'حرام', 'reason': 'اسم آخر لصبغة كارمين (E120) المستخرجة من الحشرات.'},
'e120': {'status': 'حرام', 'reason': 'الرمز الأوروبي لصبغة كارمين المستخرجة من الحشرات.'},
'e-120': {'status': 'حرام', 'reason': 'الرمز الأوروبي لصبغة كارمين المستخرجة من الحشرات.'},
'ci 75470': {'status': 'حرام', 'reason': 'الرمز الدولي لصبغة كارمين المستخرجة من الحشرات.'},

#--------------------------------------------------------------------------
# القسم الثاني: مكونات مشبوهة (Doubtful / Mashbooh)
# هذه المكونات تحتاج إلى تدقيق للمصدر للتأكد من حليتها.
#--------------------------------------------------------------------------

# --- جيلاتين ومشتقاته ---
'gelatin': {'status': 'مشتبه فيه (يميل للتحريم)', 'reason': 'مصدره الغالب حيواني (خنزير أو غير مذكى). يتطلب شهادة حلال موثوقة.'},
'e441': {'status': 'مشتبه فيه (يميل للتحريم)', 'reason': 'الرمز الأوروبي القديم للجيلاتين. مصدره الغالب حيواني (خنزير أو غير مذكى).'},
'e-441': {'status': 'مشتبه فيه (يميل للتحريم)', 'reason': 'الرمز الأوروبي القديم للجيلاتين. مصدره الغالب حيواني (خنزير أو غير مذكى).'},

# --- دهون، شحوم، ومستحلبات ذات مصدر دهني ---
'animal fat': {'status': 'مشتبه فيه', 'reason': 'دهن حيواني. يجب التأكد من أنه من مصدر مذكى شرعاً.'},
'animal shortening': {'status': 'مشتبه فيه', 'reason': 'دهن حيواني. يجب التأكد من أنه من مصدر مذكى شرعاً.'},
'fat': {'status': 'مشتبه فيه', 'reason': 'كلمة عامة للدهن. إذا لم يحدد المصدر (نباتي)، فهو مشبوه.'},
'tallow': {'status': 'مشتبه فيه', 'reason': 'الشحم الحيواني. يجب التأكد من أنه من مصدر مذكى شرعاً.'},
'shortening': {'status': 'مشتبه فيه', 'reason': 'دهن صناعي، قد يحتوي على دهون حيوانية. يجب التأكد من المصدر.'},
'margarine': {'status': 'مشتبه فيه', 'reason': 'قد يحتوي على دهون حيوانية أو مستحلبات مشبوهة المصدر.'},
'glycerin': {'status': 'مشتبه فيه', 'reason': 'قد يكون مصدره دهن حيواني أو نباتي. يجب التأكد من المصدر النباتي.'},
'glycerine': {'status': 'مشتبه فيه', 'reason': 'اسم آخر للجليسرين، قد يكون مصدره دهن حيواني أو نباتي.'},
'glycerol': {'status': 'مشتبه فيه', 'reason': 'اسم آخر للجليسرين (E422)، قد يكون مصدره دهن حيواني أو نباتي.'},
'e422': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي للجليسرين/الجليسرول. قد يكون مصدره دهن حيواني أو نباتي.'},
'e-422': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي للجليسرين/الجليسرول. قد يكون مصدره دهن حيواني أو نباتي.'},
'mono and diglycerides': {'status': 'مشتبه فيه', 'reason': 'مستحلبات (E471) قد تكون من مصدر دهني حيواني أو نباتي. يجب التحقق.'},
'monoglyceride': {'status': 'مشتبه فيه', 'reason': 'جزء من مستحلبات (E471). قد يكون مصدره دهني حيواني أو نباتي.'},
'diglyceride': {'status': 'مشتبه فيه', 'reason': 'جزء من مستحلبات (E471). قد يكون مصدره دهني حيواني أو نباتي.'},
'emulsifier': {'status': 'مشتبه فيه', 'reason': 'كلمة عامة للمستحلبات. العديد منها مشبوه المصدر (حيواني).'},
'emulsifiers': {'status': 'مشتبه فيه', 'reason': 'كلمة عامة للمستحلبات. العديد منها مشبوه المصدر (حيواني).'},
'stearic acid': {'status': 'مشتبه فيه', 'reason': 'حمض دهني (E570). قد يكون من مصدر حيواني أو نباتي.'},
'e570': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي لحمض الستياريك. قد يكون من مصدر حيواني أو نباتي.'},
'e-570': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي لحمض الستياريك. قد يكون من مصدر حيواني أو نباتي.'},
'calcium stearate': {'status': 'مشتبه فيه', 'reason': 'ملح حمض الستياريك. قد يكون مصدر الحمض دهن حيواني.'},
'magnesium stearate': {'status': 'مشتبه فيه', 'reason': 'ملح حمض الستياريك (E572). قد يكون مصدر الحمض دهن حيواني.'},
'e572': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي لـ Magnesium stearate. قد يكون مصدره دهن حيواني.'},
'e-572': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي لـ Magnesium stearate. قد يكون مصدره دهن حيواني.'},

# --- بروتينات، إنزيمات، وأحماض أمينية ---
'collagen': {'status': 'مشتبه فيه', 'reason': 'بروتين حيواني المصدر، يخضع لنفس حكم الجيلاتين.'},
'hydrolyzed animal protein': {'status': 'مشتبه فيه', 'reason': 'بروتين حيواني متحلل. يجب التأكد من مصدر الحيوان وطريقة ذبحه.'},
'pepsin': {'status': 'مشتبه فيه', 'reason': 'إنزيم يستخرج غالباً من معدة الخنزير. يجب التحقق من المصدر النباتي أو الميكروبي.'},
'enzymes': {'status': 'مشتبه فيه', 'reason': 'قد تكون من مصدر حيواني محرم، أو بكتيري أو نباتي. يتطلب التحقق.'},
'enzyme': {'status': 'مشتبه فيه', 'reason': 'قد يكون من مصدر حيواني محرم، أو بكتيري أو نباتي. يتطلب التحقق.'},
'protease': {'status': 'مشتبه فيه', 'reason': 'نوع من الإنزيمات، قد يكون من مصدر حيواني محرم.'},
'rennet': {'status': 'مشتبه فيه', 'reason': 'منفحة الجبن، قد تكون من حيوان غير مذكى شرعاً.'},
'animal rennet': {'status': 'مشتبه فيه', 'reason': 'منفحة من مصدر حيواني، يجب التأكد من طريقة الذبح.'},
'whey': {'status': 'مشتبه فيه', 'reason': 'شرش اللبن، حكمه يعتمد على حكم المنفحة المستخدمة في صناعة الجبن.'},
'whey powder': {'status': 'مشتبه فيه', 'reason': 'مسحوق شرش اللبن، حكمه يعتمد على حكم المنفحة المستخدمة.'},
'casein': {'status': 'مشتبه فيه', 'reason': 'بروتين الحليب. قد تستخدم في معالجته إنزيمات مشبوهة كالمنفحة.'},
'caseinates': {'status': 'مشتبه فيه', 'reason': 'أملاح بروتين الحليب. قد تستخدم في معالجتها إنزيمات مشبوهة.'},
'amino acids': {'status': 'مشتبه فيه', 'reason': 'بعض الأحماض الأمينية (مثل ل-سيستين) قد تكون من مصدر حيواني أو آدمي.'},
'l-cysteine': {'status': 'مشتبه فيه', 'reason': 'حمض أميني (E920) يمكن استخراجه من شعر الإنسان (حرام) أو ريش الدواجن أو مصادر صناعية.'},
'e920': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي لـ ل-سيستين. قد يستخرج من شعر الإنسان أو ريش الدواجن.'},
'e-920': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي لـ ل-سيستين. قد يستخرج من شعر الإنسان أو ريش الدواجن.'},
'e921': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي لمشتقات ل-سيستين. حكمها مماثل لـ E920.'},
'e-921': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي لمشتقات ل-سيستين. حكمها مماثل لـ E920.'},

# --- نكهات، مرق، ومكونات عامة ---
'stock': {'status': 'مشتبه فيه', 'reason': 'مرق قد يتم تحضيره من لحوم أو عظام حيوانات غير مذكاة.'},
'broth': {'status': 'مشتبه فيه', 'reason': 'مرق قد يتم تحضيره من لحوم أو عظام حيوانات غير مذكاة.'},
'bouillon': {'status': 'مشتبه فيه', 'reason': 'مكعبات مرق قد تحتوي على دهون أو بروتينات حيوانية مشبوهة.'},
'natural flavors': {'status': 'مشتبه فيه', 'reason': 'قد تحتوي على كحول كمذيب أو مشتقات حيوانية. تحتاج لتدقيق المصدر.'},
'flavouring': {'status': 'مشتبه فيه', 'reason': 'قد تحتوي على كحول كمذيب أو مشتقات حيوانية. تحتاج لتدقيق المصدر.'},
'vanilla extract': {'status': 'مشتبه فيه', 'reason': 'خلاصة الفانيليا التقليدية تحتوي على نسبة من الكحول كمذيب.'},

# --- مواد مضافة أخرى مشبوهة (Additives) ---
'shellac': {'status': 'مشتبه فيه', 'reason': 'إفراز صمغي من حشرة اللاك (E904). هناك خلاف فقهي حول حكمه.'},
'e904': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي للشيلاك. إفراز حشري يوجد خلاف فقهي في حكمه.'},
'e-904': {'status': 'مشتبه فيه', 'reason': 'الرمز الأوروبي للشيلاك. إفراز حشري يوجد خلاف فقهي في حكمه.'},
'e542': {'status': 'مشتبه فيه', 'reason': 'فوسفات العظام. مصدره عظام الحيوانات التي غالباً ما تكون غير مذكاة.'},
'e-542': {'status': 'مشتبه فيه', 'reason': 'فوسفات العظام. مصدره عظام الحيوانات التي غالباً ما تكون غير مذكاة.'},
'edible bone phosphate': {'status': 'مشتبه فيه', 'reason': 'مصدره عظام الحيوانات التي غالباً ما تكون غير مذكاة.'},
'e631': {'status': 'مشتبه فيه', 'reason': 'مُحسِّن نكهة (Sodium inosinate)، قد يُنتج من اللحوم أو الأسماك. يتطلب التحقق.'},
'e-631': {'status': 'مشتبه فيه', 'reason': 'مُحسِّن نكهة (Sodium inosinate)، قد يُنتج من اللحوم أو الأسماك. يتطلب التحقق.'},
'e635': {'status': 'مشتبه فيه', 'reason': 'مُحسِّن نكهة (Sodium 5\'-ribonucleotide)، قد يكون من مصدر حيواني.'},
'e-635': {'status': 'مشتبه فيه', 'reason': 'مُحسِّن نكهة (Sodium 5\'-ribonucleotide)، قد يكون من مصدر حيواني.'},
'e640': {'status': 'مشتبه فيه', 'reason': 'حمض أميني (Glycine)، قد يكون مشتقًا من الجيلاتين. يتطلب التحقق.'},
'e-640': {'status': 'مشتبه فيه', 'reason': 'حمض أميني (Glycine)، قد يكون مشتقًا من الجيلاتين. يتطلب التحقق.'},

# --- مجموعة المستحلبات والأملاح الدهنية المشبوهة ---
# السبب العام: قد تكون مشتقة من دهون حيوانية. تتطلب التحقق من المصدر أو شهادة حلال.
'e304': {'status': 'مشتبه فيه', 'reason': 'مادة مضافة (Ascorbyl palmitate)، قد تكون من مصدر دهني حيواني.'},
'e-304': {'status': 'مشتبه فيه', 'reason': 'مادة مضافة (Ascorbyl palmitate)، قد تكون من مصدر دهني حيواني.'},
'e322': {'status': 'مشتبه فيه', 'reason': 'مادة الليسيثين. غالباً من الصويا أو البيض (حلال)، ولكن يوضع في الشبهة للاحتياط التام.'},
'e-322': {'status': 'مشتبه فيه', 'reason': 'مادة الليسيثين. غالباً من الصويا أو البيض (حلال)، ولكن يوضع في الشبهة للاحتياط التام.'},
'e325': {'status': 'مشتبه فيه', 'reason': 'مادة مضافة (Sodium Lactate)، قد تكون من مصدر حيواني.'},
'e-325': {'status': 'مشتبه فيه', 'reason': 'مادة مضافة (Sodium Lactate)، قد تكون من مصدر حيواني.'},
'e326': {'status': 'مشتبه فيه', 'reason': 'مادة مضافة (Potassium Lactate)، قد تكون من مصدر حيواني.'},
'e-326': {'status': 'مشتبه فيه', 'reason': 'مادة مضافة (Potassium Lactate)، قد تكون من مصدر حيواني.'},
'e327': {'status': 'مشتبه فيه', 'reason': 'مادة مضافة (Calcium Lactate)، قد تكون من مصدر حيواني.'},
'e-327': {'status': 'مشتبه فيه', 'reason': 'مادة مضافة (Calcium Lactate)، قد تكون من مصدر حيواني.'},
'e430': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-430': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e431': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-431': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e432': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polysorbate 20)، قد يكون من مصدر دهني حيواني.'},
'e-432': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polysorbate 20)، قد يكون من مصدر دهني حيواني.'},
'e433': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polysorbate 80)، قد يكون من مصدر دهني حيواني.'},
'e-433': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polysorbate 80)، قد يكون من مصدر دهني حيواني.'},
'e434': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polysorbate 40)، قد يكون من مصدر دهني حيواني.'},
'e-434': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polysorbate 40)، قد يكون من مصدر دهني حيواني.'},
'e435': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polysorbate 60)، قد يكون من مصدر دهني حيواني.'},
'e-435': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polysorbate 60)، قد يكون من مصدر دهني حيواني.'},
'e436': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-436': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e442': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Ammonium phosphatides)، قد يكون من مصدر دهني حيواني.'},
'e-442': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Ammonium phosphatides)، قد يكون من مصدر دهني حيواني.'},
'e470': {'status': 'مشتبه فيه', 'reason': 'أملاح الأحماض الدهنية، قد يكون مصدرها حيوانياً.'},
'e-470': {'status': 'مشتبه فيه', 'reason': 'أملاح الأحماض الدهنية، قد يكون مصدرها حيوانياً.'},
'e470a': {'status': 'مشتبه فيه', 'reason': 'أملاح الأحماض الدهنية (صوديوم، بوتاسيوم، كالسيوم)، قد يكون مصدرها حيوانياً.'},
'e-470a': {'status': 'مشتبه فيه', 'reason': 'أملاح الأحماض الدهنية (صوديوم، بوتاسيوم، كالسيوم)، قد يكون مصدرها حيوانياً.'},
'e470b': {'status': 'مشتبه فيه', 'reason': 'أملاح المغنيسيوم للأحماض الدهنية، قد يكون مصدرها حيوانياً.'},
'e-470b': {'status': 'مشتبه فيه', 'reason': 'أملاح المغنيسيوم للأحماض الدهنية، قد يكون مصدرها حيوانياً.'},
'e471': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Mono- and diglycerides)، قد يكون من مصدر دهني حيواني أو نباتي.'},
'e-471': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Mono- and diglycerides)، قد يكون من مصدر دهني حيواني أو نباتي.'},
'e472': {'status': 'مشتبه فيه', 'reason': 'استرات متنوعة من E471، قد يكون مصدرها دهني حيواني.'},
'e-472': {'status': 'مشتبه فيه', 'reason': 'استرات متنوعة من E471، قد يكون مصدرها دهني حيواني.'},
'e472a': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e-472a': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e472b': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e-472b': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e472c': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e-472c': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e472d': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e-472d': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e472e': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e-472f': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e-472f': {'status': 'مشتبه فيه', 'reason': 'استرات من E471، قد يكون مصدرها دهني حيواني.'},
'e473': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sucrose esters)، قد يكون من مصدر دهني حيواني.'},
'e-473': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sucrose esters)، قد يكون من مصدر دهني حيواني.'},
'e474': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sucroglycerides)، قد يكون من مصدر دهني حيواني.'},
'e-474': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sucroglycerides)، قد يكون من مصدر دهني حيواني.'},
'e475': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polyglycerol esters)، قد يكون من مصدر دهني حيواني.'},
'e-475': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Polyglycerol esters)، قد يكون من مصدر دهني حيواني.'},
'e476': {'status': 'مشتبه فيه', 'reason': 'مستحلب (PGPR)، قد يكون من مصدر دهني حيواني.'},
'e-476': {'status': 'مشتبه فيه', 'reason': 'مستحلب (PGPR)، قد يكون من مصدر دهني حيواني.'},
'e477': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-477': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e478': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-478': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e479b': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-479b': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e481': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-481': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e482': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-482': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e483': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e-483': {'status': 'مشتبه فيه', 'reason': 'مستحلب مشتق من أحماض دهنية قد تكون حيوانية المصدر.'},
'e491': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan monostearate)، قد يكون من مصدر دهني حيواني.'},
'e-491': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan monostearate)، قد يكون من مصدر دهني حيواني.'},
'e492': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan tristearate)، قد يكون من مصدر دهني حيواني.'},
'e-492': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan tristearate)، قد يكون من مصدر دهني حيواني.'},
'e493': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan monolaurate)، قد يكون من مصدر دهني حيواني.'},
'e-493': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan monolaurate)، قد يكون من مصدر دهني حيواني.'},
'e494': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan monooleate)، قد يكون من مصدر دهني حيواني.'},
'e-494': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan monooleate)، قد يكون من مصدر دهني حيواني.'},
'e495': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan monopalmitate)، قد يكون من مصدر دهني حيواني.'},
'e-495': {'status': 'مشتبه فيه', 'reason': 'مستحلب (Sorbitan monopalmitate)، قد يكون من مصدر دهني حيواني.'},
}


# --- الخطوة 1: تحميل النموذج المدرب ---
model = joblib.load('halal_classifier_model.pkl')


# --- الخطوة 2: تعريف دالة التنبؤ والشرح (النسخة الهجينة) ---
def predict_and_explain(text_input):
    if not model or not text_input.strip():
        return {}, ""

    # الجزء الأول: التنبؤ باستخدام نموذج التعلم الآلي
    prediction = model.predict([text_input])[0]
    
    # الجزء الثاني: البحث عن السبب باستخدام قاعدة المعرفة
    reason = "لم يتم تحديد سبب مباشر من قاعدة المعرفة." # سبب افتراضي
    
    if prediction in ['حرام', 'مشتبه فيه']:
        # نبحث في النص عن المكونات من قاموسنا الخبير
        for ingredient, details in comprehensive_ingredients_db.items():
            # استخدام تعابير نمطية للبحث عن الكلمة كاملة
            if re.search(r'\b' + re.escape(ingredient) + r'\b', text_input, re.IGNORECASE):
                # إذا وجدنا مكوناً، نستخدم سببه ونخرج من الحلقة
                reason = details['reason']
                break # نكتفي بأول سبب نجده
    elif prediction == 'حلال':
        reason = "لم يتم العثور على مكونات محرمة أو مشبوهة واضحة."

    return prediction, reason


# --- الخطوة 3: بناء الواجهة التفاعلية ---
iface = gr.Interface(
    fn=predict_and_explain,
    inputs=gr.Textbox(lines=5, label="أدخل اسم المنتج والمكونات"),
    outputs=[
        gr.Textbox(label="الحكم الشرعي المتوقع (Predicted Status)"),
        gr.Textbox(label="السبب المحتمل (Potential Reason)")
    ],
    title="نظام خبير لتصنيف المنتجات الغذائية",
    description="أدخل معلومات المنتج لتحصل على الحكم الشرعي المتوقع مع السبب المحتمل.",
    examples=[["Prosciutto crudo"], ["Cheddar cheese, water, salt, rennet"]]
)

iface.launch()